<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>uname</title>
    <link rel="stylesheet" href="assets/index.css">
    <link rel="icon" type="image/x-icon"
        href="https://play-lh.googleusercontent.com/_TNbiYKasPy_isTSEg2_UEzVaev4F8fO2lunsHJ8_Ux2g3OzkSZyzpqvJG1woSj-WD4=w240-h480-rw">
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
</head>
<body>
<img src="https://i.imgur.com/vwIQErh.png" alt="Logo" class="logo">
<div class="logo_text">Formularz Rejestracji</div>

<div class="upload">
    <span class="upload_text">Dodaj zdjęcie:</span>
    <div class="upload_grid">
        <img src="https://i.imgur.com/vwIQErh.png" alt="Preview" class="upload_image" id="preview">
    </div>
    <input type="text" id="imgurLink" class="input" placeholder="https://i.imgur.com/TwojeZdjecie.jpg" style="margin-top:10px;">
</div>

<!-- Wszystkie pola formularza -->
<div class="input_holder"><input type="text" id="name" class="input"><span class="placeholder">Imię (imiona)</span></div>
<div class="input_holder"><input type="text" id="surname" class="input"><span class="placeholder">Nazwisko</span></div>
<div class="input_holder"><input type="text" id="sex" class="input"><span class="placeholder">Płeć</span></div>
<div class="input_holder"><input type="text" id="nationality" class="input"><span class="placeholder">Obywatelstwo</span></div>
<div class="input_holder"><input type="text" id="birthday" class="input"><span class="placeholder">Data urodzenia (DD.MM.YYYY)</span></div>
<div class="input_holder"><input type="text" id="familyName" class="input"><span class="placeholder">Nazwisko rodowe</span></div>
<div class="input_holder"><input type="text" id="fathersFamilyName" class="input"><span class="placeholder">Nazwisko rodowe ojca</span></div>
<div class="input_holder"><input type="text" id="mothersFamilyName" class="input"><span class="placeholder">Nazwisko rodowe matki</span></div>

<p class="subtext">Miejsce zamieszkania</p>
<div class="input_holder"><input type="text" id="birthPlace" class="input"><span class="placeholder">Miejsce urodzenia</span></div>
<div class="input_holder"><input type="text" id="countryOfBirth" class="input"><span class="placeholder">Kraj urodzenia</span></div>
<div class="input_holder"><input type="text" id="adress1" class="input"><span class="placeholder">Ulica i numer domu</span></div>
<div class="input_holder"><input type="text" id="adress2" class="input"><span class="placeholder">Kod pocztowy</span></div>
<div class="input_holder"><input type="text" id="city" class="input"><span class="placeholder">Miasto</span></div>
<div class="input_holder"><input type="text" id="checkInDate" class="input"><span class="placeholder">Data zameldowania na pobyt stały (DD.MM.YYYY)</span></div>

<a class="go" id="goBtn">wejdź</a>

<!-- Modal do sprawdzenia użytkownika -->
<div id="userModal" style="display:none; position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;">
  <div style="background:#1e1e2f;padding:20px;border-radius:12px;width:300px;text-align:center;color:white;position:relative;">
    <h3>Podaj hasło</h3>
    <input type="password" id="modalPassword" placeholder="Hasło" style="width:100%;padding:8px;margin-top:10px;border-radius:6px;border:none;">
    <p id="modalError" style="color:red;font-size:12px;margin-top:5px;display:none;">Niepoprawne hasło!</p>
    <button id="submitPassword" style="margin-top:10px;padding:8px 14px;border:none;border-radius:6px;background:#00ff9f;color:#000;font-weight:600;cursor:pointer;">Pokaż użytkownika</button>
    <button id="closeModal" style="position:absolute;top:10px;right:12px;background:transparent;border:none;color:white;font-size:18px;cursor:pointer;">&times;</button>
    <div id="userInfo" style="margin-top:15px;display:none;font-size:14px;"></div>
  </div>
</div>

<button onclick="logout()" style="position:fixed;top:15px;right:15px;background:#ff4d4d;color:white;border:none;border-radius:6px;padding:8px 14px;cursor:pointer;z-index:9999;">Wyloguj</button>
<button id="checkUserBtn" style="position:fixed;bottom:15px;right:15px;background:#007bff;color:white;border:none;border-radius:6px;padding:8px 14px;cursor:pointer;z-index:9999;">Sprawdź użytkownika</button>

<script>
(function(){
    if (localStorage.getItem("loggedIn") !== "true") {
        window.location.href = "lajon.html";
    }

    // Podgląd obrazka
    const imgurInput = document.getElementById('imgurLink');
    const preview = document.getElementById('preview');

    function isValidImgur(link) {
        if (!link) return false;
        link = link.trim();
        return link.startsWith('https://i.imgur.com/') && (
            link.endsWith('.jpg') || link.endsWith('.jpeg') || link.endsWith('.png') || link.endsWith('.gif')
        );
    }

    imgurInput.addEventListener('input', () => {
        const link = imgurInput.value.trim();
        if (isValidImgur(link)) preview.src = link;
    });

    const params = new URLSearchParams(window.location.search);
    let photo = params.get('photo');
    if(photo && isValidImgur(decodeURIComponent(photo))){
        imgurInput.value = decodeURIComponent(photo);
        preview.src = decodeURIComponent(photo);
    }

    // Button "wejdź"
    const goBtn = document.getElementById('goBtn');
    goBtn.addEventListener('click', () => {
        const fields = ["name","surname","sex","nationality","birthday","familyName","fathersFamilyName","mothersFamilyName","birthPlace","countryOfBirth","adress1","adress2","city","checkInDate"];
        const newParams = new URLSearchParams();
        fields.forEach(f => {
            const val = document.getElementById(f).value.trim();
            if(val) newParams.append(f,val);
        });
        const photoLink = imgurInput.value.trim();
        if(isValidImgur(photoLink)) newParams.append('photo',photoLink);
        window.location.href = `card.html?${newParams.toString()}`;
    });

    // Modal sprawdzania użytkownika
    const decode = str => atob(str);
    const encryptedPassword = "bWVmYWFkbWluYQ==";
    const storageKey = btoa("username");

    const checkBtn = document.getElementById('checkUserBtn');
    const modal = document.getElementById('userModal');
    const closeModal = document.getElementById('closeModal');
    const submitPassword = document.getElementById('submitPassword');
    const modalPassword = document.getElementById('modalPassword');
    const modalError = document.getElementById('modalError');
    const userInfo = document.getElementById('userInfo');

    checkBtn.addEventListener('click', () => {
        modal.style.display = "flex";
        modalPassword.value = "";
        modalError.style.display = "none";
        userInfo.style.display = "none";
    });

    closeModal.addEventListener('click', () => { modal.style.display = "none"; });

    submitPassword.addEventListener('click', () => {
        if(modalPassword.value === decode(encryptedPassword)){
            const username = localStorage.getItem(atob(storageKey)) || 'Nieznany';
            const userIP = localStorage.getItem('userIP') || 'Nieznany';
            userInfo.innerHTML = `
                <strong>Zalogowany użytkownik:</strong> ${username}<br>
                <strong>IP użytkownika:</strong> ${userIP}
            `;
            userInfo.style.display = "block";
            modalError.style.display = "none";
        } else { 
            modalError.style.display = "block"; 
            userInfo.style.display = "none"; 
        }
    });

    window.addEventListener('click', e => { 
        if(e.target === modal) modal.style.display = "none"; 
    });

    window.logout = function() {
        localStorage.removeItem('loggedIn'); 
        localStorage.removeItem('username'); 
        localStorage.removeItem('userIP');
        window.location.href='lajon.html'; 
    }

    const uname = localStorage.getItem('username') || 'uname';
    const usernameDisplay = document.getElementById('usernameDisplay');
    if(usernameDisplay) usernameDisplay.textContent = uname;

})();
</script>

</body>
</html>
